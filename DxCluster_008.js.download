google.load('visualization','1',{packages:['table','geochart']});var lastId=0,data,dxccData,geoData,nDxerCol,nDxccCol,nFreqCol,nFreqLinkCol,nTimeCol,nCommCol,nSpotterCol,nAzimutCol,nSMeterCol,ajax=null,dxccTable=null,geoChart=null,chart,table,fullTable,timeFormatter,filter=[{column:2,minValue:0}],hlto=-1,lastMapUpdate=-1,lastDxcc=-1,clusterPaused=!1,buttonPause=!1,btnPause,pauseBlink=!0,enableBlink=!0,updTick,consentPrefCookies=-1!=getCookie('cookieconsent','').indexOf('P');function addButton(a,b,c){var d=$('<button/>').text(b),f=a.find('[role=\'button\']:last').css('right');return d.button({icons:{primary:c},text:!1}).addClass('ui-dialog-titlebar-close').css('right',parseInt(f)+26+'px').appendTo(a),d}$(function(){$('#dialog').dialog({title:'HRDLOG.net - DX Cluster - '+user_call+' @ '+user_locator,width:800,height:500,modal:!1,open:function(){$(this).css('overflow','hidden');var c=$(this).parent().children('.ui-dialog-titlebar');'1'==full_screen||self!=top?($('.ui-dialog-titlebar-close').hide(),$('#dialog').dialog({draggable:!1,closeOnEscape:!1}),$('#'+imgId).hide()):addButton(c,'New window','ui-icon-newwin').click(function(){window.open('DxCluster.aspx?full_screen=1','popup','menubar=no,resizable=yes,status=no,titlebar=no,toolbar=no'),window.location.href='Default.aspx'}),btnPause=addButton(c,'Paused','ui-icon-pause').click(function(){buttonPause=!buttonPause,loadCluster()})},close:function(){window.location.href='Default.aspx'},resizeStop:function(){updateTable()}}).show();var a='<option value="All">All</option>';for(i=0;i<bands.length;i++)a+='<option value="'+bands[i][0]+'">'+bands[i][0]+'</option>';$('#band').append(a),$('#band').change(function(){var d=$('#band').val();setBandFilter(d),consentPrefCookies&&setCookie('cluster_band',d,30),updateTable()}),$get('img_clear').src='images/transp.png',$('#callsign').keyup(function(){updateOnKeyUp()}),$('#highlight').keyup(function(){updateOnKeyUp()}),$('#cbpartial').change(function(){updateTable()});var b=getCookie('cluster_band','All');$('#band').val(b),$('#callsign').val(getCookie('cluster_callsign','')),$('#highlight').val(getCookie('cluster_highlight','')),$('#img_clear').click(function(){$('#band').val('All'),$('#callsign').val(''),$('#highlight').val(''),$get('img_clear').src='images/transp.png'}),createDataTable(),loadCluster(),createDxccDataTable(),setBandFilter(b),updTick=1,setInterval(timer_func,1e3),'1'==full_screen&&($(window).resize(function(){$('#dialog').dialog({width:$(window).width()-9,height:$(window).height()}),updateTable()}).resize(),$('#dialog').dialog({resizable:!1}))});function setBandFilter(a){filter=[{column:nFreqCol,minValue:0}];for(var b=0;b<bands.length;b++)if(a==bands[b][0]){filter=[{column:nFreqCol,minValue:bands[b][1]/1e3,maxValue:bands[b][2]/1e3}],$('#img_clear').src='images/clearFilter.png';break}}function updateOnKeyUp(){0<=hlto&&clearTimeout(hlto),hlto=setTimeout('updateTable()',1e3)}function createDataTable(){table=new google.visualization.Table(document.getElementById('table_div')),data=new google.visualization.DataTable,nDxerCol=data.addColumn('string','DXer'),nDxccCol=data.addColumn('string','DXCC'),nFreqCol=data.addColumn('number','Freq'),nFreqLinkCol=data.addColumn('string','Freq'),nTimeCol=data.addColumn('datetime','Time'),nCommCol=data.addColumn('string','Comment'),nAzimutCol=data.addColumn('number','Azimut'),nSMeterCol=data.addColumn('string','S-Meter'),nSpotterCol=data.addColumn('string','Spotter'),timeFormatter=new google.visualization.DateFormat({pattern:'HH:mm'})}function createGeoDataTable(){geoData=new google.visualization.DataTable,geoData.addColumn('string','Country'),geoData.addColumn('number','QSO'),$.each(user_dxcc.UserDxcc,function(a,b){var c=$.grep(countries,function(d){return d[1]==b.DXCC});0<c.length&&geoData.addRow([c[0][0],b.ud_qso])}),chart=new google.visualization.GeoChart(document.getElementById('table_div'))}function upd_cluster(){updTick=1}function timer_func(){return updTick--,buttonPause||clusterPaused?(btnPause.css({border:pauseBlink?'1px solid red':''}),void(pauseBlink=!pauseBlink)):void(0>=updTick&&(updTick=30,loadCluster()))}function loadCluster(){if(!(buttonPause||clusterPaused)&&!('boolean'==typeof document.hidden&&document.hidden)){var a=$('#personPopupContainer');if(!(a&&'block'==a.css('display'))){pauseBlink=!0,enableBlink=!0,btnPause.css({border:''}),$get('img_status').src='images/indicator.gif',$('#table_div').fadeTo(600,0.7);var b=$.getJSON('dxcluster.aspx',{id:lastId,code:magic_code,locator:user_locator,output:'JSON'});b.done(function(c){$get('img_status').src='images/transp.png',$('#table_div').fadeTo(50,1),clusterPaused||(drawTable(c),updTick=15)}),b.fail(function(){$get('img_status').src='images/cancel.png',location.reload()})}}}function highlight(a,b){return null==a?b:'<div style="background: '+a+'">'+b+'</div>'}function getDxccImage(a,b){return'<img src="http://www.hrdlog.net/images/flags/'+a+'.png" title="'+b+'">'}function drawTable(a){$.each(a.DxCluster,function(b,c){var d=parseInt(c.Freq),f=$.grep(user_dxcc.UserDxcc,function(q){return q.DXCC==c.DXCC}),g=$.grep(bands,function(q){return d>=q[1]&&d<=q[2]});0==g.length&&g.push(['???',0,0]);var h=null,j='';0<user_dxcc.UserDxcc.length&&0!=c.DXCC&&(0==f.length?(h='#FFD800',j='NEW ONE !'):0==f[0].ud_confirmed?(h='#00FFFF',j='NOT confirmed'):0>$.inArray(g[0][0],f[0].BandMHz.split(','))&&(h='#E0EBEB',j='NO QSO on this band'));var k=' ',l='';if(c.Muf){var o='',p=c.Muf.Hour[0].Freq[0].Flags;switch(c.Muf.Hour[1].Freq[0].RxPower<=c.Muf.Hour[0].Freq[0].RxPower&&p?(l='<img src="images/SorterDescActive.png">',o=' decreasing'):c.Muf.Hour[1].Freq[0].Flags&&(l='<img src="images/SorterAscActive.png">',o=' increasing'),k='SFI: '+$.formatNumber(c.Muf.SolarFlux,{format:'#'})+' R: '+$.formatNumber(c.Muf.SunSpot,{format:'#'})+'<br/>Power: '+$.formatNumber(c.Muf.TxPower,{format:'#.0'})+'dbW RxSens: '+c.Muf.RxSens+'dbM<br/> Distance: '+$.formatNumber(c.Muf.Distance,{format:'#,###'})+'km Delay: '+$.formatNumber(c.Muf.Delay,{format:'#'})+'ms<br/>UT: '+c.Muf.Hour[0].UT+' LT: '+c.Muf.Hour[0].LT+'<br/>'+(c.Muf.Hour[0].Freq[0].Freq>c.Muf.Hour[0].MUF?'<font color=\'red\'>MUF</font>':'MUF')+': '+$.formatNumber(c.Muf.Hour[0].MUF,{format:'#.0'})+'MHz Zenith: '+$.formatNumber(c.Muf.Hour[0].Zenith,{format:'#'})+'<br/> S-Meter: '+c.Muf.Hour[0].Freq[0].SMeter+o+'<br/>',3&p){case 1:k+='j = path in daytime</br>';break;case 2:k+='n = path in nighttime</br>';break;case 3:k+='x = path in daytime and nighttime</br>';}4&p?k+='s = signal &gt; noise, but signal &lt; sensitivity</br>':16&p&&(k+='m = less than 3 dB above the RMS sum of the other paths</br>')}data.insertRows(0,[['<a href="#" class="personPopupTrigger" rel="callsign,'+c.DXer+';'+c.DXer+';"><b>'+c.DXer+'</b></a>',highlight(h,'<div class="dxcc-div" dxcc="'+(0<f.length?c.DXCC:-c.DXCC)+'" dxcc-name="'+c.Country+'" dxcc-confirm="'+j+'" dxcc-band="'+g[0][0]+'" dxcc-freq="'+d+'">'+getDxccImage(c.DXCC,c.Country)+'<small>'+c.Country+'</small></div>'),d/1e3,'<div align="right"><a href="#" class="setFreqTrigger" rel="'+d+'">'+$.formatNumber(d/1e3,{format:'0,000.0'})+'</a></div>',new Date(parseInt(c.Time.substr(6))),c.Comment,0<=c.Azimut?c.Azimut:null,'<div class="muf-div" muf-txt="'+k+'" muf-call="'+c.DXer+'" align="center" width="100%">&nbsp;'+(c.Muf?c.Muf.Hour[0].Freq[0].SMeter:'-')+' '+l+'&nbsp;</div>',c.Spotter]]),c.ID>lastId&&(lastId=c.ID)}),updateTable()}function setDxccPosition(){var a=$('#table_div').offset(),b=$('#table_div').width(),c=$('#dxcc_details').width();$('#dxcc_details').css({left:a.left+b-c+'px',top:a.top+'px'})}function updateTable(){0<=hlto&&(clearTimeout(hlto),hlto=0),timeFormatter.format(data,nTimeCol);var a=[],b=$('#highlight').val().toUpperCase();consentPrefCookies&&setCookie('cluster_highlight',b,30);var c=b.split(' '),d=$('#callsign').val().toUpperCase();consentPrefCookies&&setCookie('cluster_callsign',d,30),nRow=data.getNumberOfRows();for(var f=0;f<nRow;f++){for(var g='',h=data.getValue(f,nCommCol).toUpperCase(),j=0;j<c.length;j++)if(0!=c[j].length&&0<=h.indexOf(c[j])){g='background-color: yellow;',a.push(f);break}data.setProperty(f,nCommCol,'style',g),g='',0<d.length&&0<=data.getValue(f,nDxerCol).toUpperCase().indexOf(d)&&(g='background-color: yellow;',a.push(f)),data.setProperty(f,nDxerCol,'style',g)}(0<b.length||0<d.length)&&($get('img_clear').src='images/clearFilter.png');var k=new google.visualization.DataView(data),l=data.getFilteredRows(filter);0<a.length?($('#span_count').html('('+a.length+')'),$('#cbpartial').removeAttr('disabled'),$('#cbpartial')[0].checked&&(l=l.filter(function(p){return 0<=a.indexOf(p)}))):($('#span_count').html(0<c.length&&0<c[0].length||0<d.length?'-':''),$('#cbpartial').attr('checked',!1),$('#cbpartial').attr('disabled',!0)),k.setRows(l),k.hideColumns([nFreqCol]),0==user_locator.length&&(k.hideColumns([nAzimutCol]),k.hideColumns([nSMeterCol])),table.draw(k,{allowHtml:!0,width:$('#dialog').outerWidth()-35,height:$('#dialog').outerHeight()-90}),HrdSocket.setFreqTrigger();var o=new Date().getMinutes();o!=lastMapUpdate&&(lastMapUpdate=o,$get(imgId).src=imgServer+'map.aspx?time='+escape(new Date)),0<user_dxcc.UserDxcc.length&&($('.dxcc-div').mouseover(function(){viewDxcc($(this))}),$('.dxcc-div').mouseout(function(){hideDetailDlg()})),$('.muf-div').mouseover(function(p){viewMuf($(this),p)}),$('.muf-div').mouseout(function(){hideDetailDlg()}),fullTable=$('#table_div > div > div:first'),fullTable.scroll(function(){0==fullTable.scrollTop()?unPause():pause()})}function pause(){clusterPaused=!0,pauseBlink=!0,btnPause.css({border:'1px solid red'})}function unPause(){3>updTick&&(updTick=3),btnPause.css({border:''}),clusterPaused=!1}function viewDxcc(a){var b=parseInt(a.attr('dxcc'));pause(),setDxccPosition(),0<b?loadDxcc(b,a.attr('dxcc-name'),a.attr('dxcc-confirm'),a.attr('dxcc-band'),a.attr('dxcc-freq')):loadGeo(b,a.attr('dxcc-name'),a.attr('dxcc-confirm'))}function viewMuf(a,b){var c=a.attr('muf-txt'),d=a.attr('muf-call');pause(),$('#dxcc_title').text('MUF '+d),$('#dxcc_header').text(''),$('#dxcc_details').css('display','block'),$('#detailPopupContent').html(c),setDxccPosition(),$('#dxcc_details').css({top:b.pageY+5+'px'})}function hideDetailDlg(){fullTable&&0==fullTable.scrollTop()&&unPause(),$('#dxcc_details').css('display','none')}function createDxccDataTable(){dxccData=new google.visualization.DataTable,nBandDxccCol=dxccData.addColumn('string','Band'),nModeDxccCol=dxccData.addColumn('string','Mode'),nQsoDxccCol=dxccData.addColumn('number','QSO'),nConfirmDxccCol=dxccData.addColumn('string','Confirms')}function clearCharts(){dxccTable&&dxccTable.clearChart(),geoChart&&geoChart.clearChart(),dxccTable=null,geoChart=null,$('#detailPopupContent').html('<img src="images/indicator.gif" width="16" height="16" />')}function loadDxcc(a,b,c,d,f){var g=parseInt(f);$('#dxcc_title').html(getDxccImage(a,b)+' '+b+' '+$.formatNumber(g/1e3,{format:'#,###.0'})+' / '+d),$('#dxcc_header').text(c),$('#dxcc_details').css('display','block');a==lastDxcc||(lastDxcc=a,clearCharts(),ajax&&ajax.abort(),ajax=$.getJSON('dxcluster.aspx',{dxcc:a,code:magic_code,output:'JSON'}),ajax.done(function(h){ajax=null,drawDxccTable(h,b,d,f)}),ajax.fail(function(){ajax=null,$('#detailPopupContent').html('<img src="images/cancel.png" />')}))}function drawDxccTable(a){createDxccDataTable(),$.each(a.UserDxcc,function(g,h){return h.DXCC==lastDxcc?void dxccData.addRow([h.BandMHz,h.Mode,h.ud_qso,'<div align="center"><img src="http://www.hrdlog.net/images/'+(0<h.ud_Qsl?'qsl.png':'small-yellow-dot.png')+'" width="8" height="16"><img src="http://www.hrdlog.net/images/'+(0<h.ud_EQsl?'eqsl.png':'small-yellow-dot.png')+'" width="8" height="16"><img src="http://www.hrdlog.net/images/'+(0<h.ud_LoTW?'arrl.png':'small-yellow-dot.png')+'" width="8" height="16"></div>']):void $('#detailPopupContent').html('<img src="images/cancel.png" />')});var f=$('#table_div').height();dxccTable=new google.visualization.Table(document.getElementById('detailPopupContent')),google.visualization.events.addListener(dxccTable,'ready',function(){setDxccPosition()}),dxccTable.draw(dxccData,{allowHtml:!0,width:'automatic',height:f-15})}function loadGeo(a,b,c){if($('#dxcc_title').text(b),$('#dxcc_details').css('display','block'),$('#dxcc_header').text(c),a!=lastDxcc){lastDxcc=a,clearCharts();var d=google.visualization.arrayToDataTable([['Country'],[b]]);geoChart=new google.visualization.GeoChart(document.getElementById('detailPopupContent')),google.visualization.events.addListener(geoChart,'ready',function(){setDxccPosition()}),geoChart.draw(d,{displayMode:'markers',width:400,height:300})}}